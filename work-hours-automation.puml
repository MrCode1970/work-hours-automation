@startuml
title work-hours-automation: Executables Overview

skinparam componentStyle rectangle
skinparam shadowing false

actor "User" as User
component "run.sh" as RunSh
component "run.py" as RunPy
component "config.py" as Config
component "sheets_client.py" as SheetsClient
component "sync_logic.py" as SyncLogic
component "ylm_portal.py" as Portal
component "ylm_actions.py" as Actions

cloud "YLM Portal\nins.ylm.co.il" as YLM
cloud "Google Sheets API" as GAPI

database "Excel file\nlocal_data.xlsx" as Excel

database "Google Sheet\nM.YY + Изменения M.YY" as GSheet

User --> RunSh : start
RunSh --> RunPy : python run.py

RunPy --> Config : load_config()
RunPy --> Portal : download_excel()
Portal --> Actions : build actions
Portal --> YLM : login + report + export
Portal --> Excel : save_as(excel_path)
RunPy --> SheetsClient : open_spreadsheet()
SheetsClient --> GAPI : authorize
SheetsClient --> GSheet : open_by_key()
RunPy --> SyncLogic : build_changes_sheet()
SyncLogic --> Excel : read with pandas
SyncLogic --> GSheet : update base + changes sheet

@enduml

@startuml
title run.sh: Environment Bootstrap

start
:locate project dir;
:ensure .venv exists;
if (missing .venv?) then (yes)
  :print error and exit 1;
  stop
endif
:activate .venv;
if (.env exists?) then (yes)
  :export variables from .env;
endif
:print python path and version;
:python run.py;
stop
@enduml

@startuml
title run.py: Main Flow (Executable)

start
:parse args (--month optional);
:load_config from env;
:ensure history/ exists;

if (--month provided?) then (yes)
  :compute sheet_name + first_day;
  :excel_path = history/{M.YY}.xlsx;
  if (archive exists?) then (yes)
    :use archive;
  else (no)
    if (SKIP_DOWNLOAD?) then (yes)
      :raise RuntimeError;
      stop
    else (no)
      :download Excel to temp;
      :rename to archive;
    endif
  endif
else (no)
  :sheet_name = current month;
  if (SKIP_DOWNLOAD?) then (yes)
    :use EXCEL_PATH;
  else (no)
    :archive previous month if needed;
    :download Excel to temp;
    :rename to EXCEL_PATH;
  endif
endif

:open Google Sheet;
:open worksheet M.YY;
:build changes sheet;
:fill empty C/D/K/L from site data;
:print "Готово";
stop
@enduml

@startuml
title config.py: Environment Loading

start
:read SITE_USERNAME;
:read SITE_PASSWORD;
:read GSHEET_ID;
:read GOOGLE_JSON_FILE (default service_key.json);
:read EXCEL_PATH (default local_data.xlsx);
:read HEADLESS (bool);
:read SKIP_DOWNLOAD (bool);
if (missing required env?) then (yes)
  :raise RuntimeError;
  stop
else (no)
  :return config dict;
  stop
endif
@enduml

@startuml
title sheets_client.py: Google Sheets Access

start
:Credentials.from_service_account_file();
:authorize client;
:open_by_key(gsheet_id);
:month_sheet_name();
:worksheet(sheet_name);
stop
@enduml

@startuml
title ylm_actions.py: Actions Builder

start
:build actions list;
:goto login page;
:fill credentials;
:open report;
:set date range;
:download Excel;
stop
@enduml

@startuml
title ylm_portal.py: download_excel

start
:launch Playwright browser;
:new_context + new_page;
:start tracing;
:if MANUAL_PORTAL;
if (manual mode?) then (yes)
  :fill login + password;
  :wait for user download;
  if (download failed?) then (yes)
    :raise RuntimeError\n"Excel не был скачан";
    stop
  endif
else (no)
  :run actions list;
  :download Excel;
endif
:stop tracing + close browser;
:return excel_path;
stop
@enduml

@startuml
title sync_logic.py: build_changes_sheet

start
if (Excel has required columns?) then (yes)
  :read Excel (תאריך, כניסה, יציאה);
else (no)
  :raise RuntimeError;
  stop
endif
:group site rows by date;
:read base sheet values (B:L);
:build base_by_date (date -> row_num, C/D, K/L);
:init base_updates + changes_rows;

while (for each date in site_by_date)
  :resolve base date by variants;
  if (date not in base?) then (yes)
    :skip date;
  else (no)
    :pick first two intervals from site;
    :load my values (C/D, K/L);
    :fill empty C/D/K/L from site (queued);
    :update cache for date;
    if (no diffs in main and bonus?) then (yes)
      :skip date;
    else (no)
      :append main row;
      if (bonus present?) then (yes)
        :append bonus row (no date);
      endif
    endif
  endif
endwhile

:apply base_updates to month sheet;
if (changes_rows empty?) then (yes)
  :delete changes sheet;
  stop
else (no)
  :recreate changes sheet;
  :write A1 date stamp;
  :write merged headers (rows 3-4);
  :write data block (rows 5+);
  :set time formats (B-F);
  :apply background colors (Fact vs Table);
  :apply conditional formatting rules;
  :write totals formula;
  stop
endif
@enduml
