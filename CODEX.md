Проект: **work-hours-automation**
Путь: `/home/vitaliy/mr1970code/work-hours-automation`

### Назначение

Автоматизировать контроль рабочего времени:

1. получить табель из YLM (скачивание через Playwright или локальный источник);
2. нормализовать в единый `local_data.xlsx`;
3. сравнить с листом месяца `M.YY` в Google Sheets;
4. синхронизировать только разрешённые пустые ячейки;
5. собрать лист **`Изменения M.YY`** как витрину текущих расхождений.

Важно: лист `Изменения M.YY` — это **не журнал событий**, а снимок текущих расхождений. Если расхождений нет — лист удаляется/не создаётся.

### Актуальный поток выполнения (`run.py`)

1. Читает конфиг через `load_config()`.
2. Определяет целевой месяц:
- из `--month M.YY`, если передан;
- иначе по текущей дате;
- при наличии источника может переопределить по данным Excel (`_infer_month_from_excel`).
3. Выбирает источник в порядке приоритета:
- `SOURCE_FILE` (pdf/xlsx/xls) — приоритет выше всех;
- `MOBILE_UI=1` — мобильный ручной режим;
- `SKIP_DOWNLOAD=1` — использовать готовый `local_data.xlsx`;
- иначе автоматическое скачивание с портала (`download_excel`).
4. Нормализует источник в `local_data.xlsx` через `parsers/normalize_source.py`.
5. Сохраняет исходный скачанный файл в `downloads/<M.YY>/DD.MM.YY.<ext>`.
6. Открывает spreadsheet и лист месяца `M.YY`.
7. Запускает `build_changes_sheet(...)`.

### Режимы получения источника

- `SOURCE_FILE=/path/to/file.pdf` или `.xlsx/.xls`:
  файл берётся локально и нормализуется без скачивания с портала.
- `MOBILE_UI=1`:
  открывается мобильный UI (`open_portal_mobile`), пользователь вручную завершает вход/действия, скрипт ждёт скачанный файл.
- `MANUAL_PORTAL=1`:
  обычный desktop browser, но скачивание делается вручную пользователем (`download_excel_manual`).
- По умолчанию:
  автоматический сценарий шагов из `ylm_actions.py`.

### Архитектура (текущее состояние)

- `run.py` — orchestration, выбор источника, месяца, запуск синхронизации.
- `config.py` — env-конфиг и bool-парсинг.
- `ylm_portal.py` — Playwright-режимы скачивания (авто, manual, mobile).
- `ylm_actions.py` — декларативный сценарий действий на портале.
- `parsers/parse_excel_ylm.py` — разбор исходного Excel в `RawAttendance`.
- `parsers/parse_pdf_ylm.py` — разбор PDF (табличный режим TYPE_A и текстовый fallback TYPE_B).
- `parsers/raw_to_local.py` — приведение к целевым колонкам `local_data.xlsx`.
- `parsers/write_local_xlsx.py` — атомарная запись `local_data.xlsx`.
- `parsers/normalize_source.py` — общий pipeline нормализации + debug raw dump.
- `sheets_client.py` — подключение к Google Sheets и выбор листа.
- `sync_logic.py` — сравнение, дозаполнение, создание/удаление листа `Изменения M.YY`.

### Форматы и колонки

Источник (после нормализации в `local_data.xlsx`) содержит минимум:
- `תאריך` (дата)
- `כניסה` (вход)
- `יציאה` (выход)

Дополнительно могут быть:
- `אתר`
- `הערות`

Лист месяца `M.YY` в Google Sheets:
- дата: колонка `B`
- вход/выход (основные): `C`, `D`
- вход/выход (бонус): `K`, `L`

### Правила синхронизации (`sync_logic.py`)

1. Время нормализуется к `HH:MM` перед сравнением (`7:00` == `07:00`).
2. Для каждой даты из табеля берутся максимум 2 интервала (основной + бонус).
3. Если даты нет в листе месяца — это отдельная секция в листе изменений.
4. Разрешённое изменение в базовом листе:
- заполнять пустые `C/D` значениями из табеля;
- `K/L` заполняются только если строка была пустой по основному интервалу и была дозаполнена в этой сессии.
5. Уже заполненные пользовательские значения не перезаписываются.
6. После дозаполнения сравнение делается по текущим значениям.

### Отчёт о дозаполнениях (консоль)

При каждом запуске выводится явный отчёт:
- `Дозаполнение: добавлено ячеек=0.` — если ничего не добавлено;
- или `Дозаполнение: добавлено ячеек=N, дат=M.` + строки по датам с деталями (`C=.., D=.., K=.., L=..`).

Это позволяет видеть факт добавления даже когда итог: `Расхождений нет`.

### Лист `Изменения M.YY`

Лист создаётся/пересоздаётся через Google Sheets `batchUpdate`.

Структура:
- `A1`: `Дата изменений: DD.MM.YYYY`
- заголовки в строках 3-4
- данные с 5-й строки
- колонки: `Дата | Факт (B:C) | Табель (D:E) | Разница`
- бонусный интервал идёт отдельной строкой без даты
- внизу строка `Итого:` и сумма столбца разницы

Оформление:
- разные фоны для блока `Факт` и `Табель`
- условное форматирование для отклонений и знака разницы
- формат времени `hh:mm`, для разницы `[h]:mm`

Если нет расхождений и нет отсутствующих дат:
- лист `Изменения M.YY` удаляется (или не создаётся).

### Полезные переменные окружения

Обязательные:
- `SITE_USERNAME`
- `SITE_PASSWORD`
- `GSHEET_ID`

Часто используемые:
- `GOOGLE_JSON_FILE` (по умолчанию `service_key.json`)
- `EXCEL_PATH` (по умолчанию `local_data.xlsx`)
- `SOURCE_FILE`
- `SKIP_DOWNLOAD`
- `MANUAL_PORTAL`
- `MANUAL_DOWNLOAD_TIMEOUT_MS`
- `MOBILE_UI`
- `MOBILE_DEVICE`
- `HEADLESS`
- `ACTION_DELAY`
- `DEBUG_SAVE_RAW`
- `DEBUG_PDF`
- `PDF_STRIP_BIDI`
- `PDF_REVERSE_HEBREW`

### Запуск

- Обычный запуск:
  `./run.sh`
- Без скачивания, по локальному `local_data.xlsx`:
  `SKIP_DOWNLOAD=1 ./run.sh`
- С явным локальным источником:
  `SOURCE_FILE=/abs/path/report.pdf ./run.sh`
- За конкретный месяц:
  `./run.sh --month 1.26`
- Мобильный ручной режим:
  `MOBILE_UI=1 ./run.sh`
- Ручной режим на desktop:
  `MANUAL_PORTAL=1 ./run.sh`

### Тесты

Текущие тесты находятся в `tests/` и покрывают:
- генерацию запросов для листа изменений;
- приоритет источника (`SOURCE_FILE` выше `SKIP_DOWNLOAD`);
- парсеры и нормализацию;
- отчёт о дозаполнении при отсутствии расхождений.
